<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Método de pagamento</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg:#f3f5f4; --card:#fff; --borda:#e8ebea;
      --verde:#42761d; --sub:#6b776a; --txt:#1f2a1e
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui;color:var(--txt)}
    .wrapper{max-width:880px;margin:16px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--borda);border-radius:14px;padding:18px}
    .tituloSecao{font-size:18px;font-weight:700;margin-bottom:14px}
    .topRow{display:flex;justify-content:space-between;align-items:center;padding:12px;border:1px solid var(--borda);border-radius:10px}
    .small{font-size:13px;color:var(--sub)}
    .method{margin-top:14px;border:2px solid #2563eb;border-radius:12px;padding:14px;background:#eef3ff}
    .summary{margin-top:18px;border-top:1px solid var(--borda);padding-top:12px}
    .total{font-size:18px;font-weight:800}
    .cotas{margin-top:6px}
    .btn{width:100%;height:48px;border-radius:10px;border:0;background:var(--verde);color:#fff;font-weight:800;margin-top:18px;cursor:pointer}
    .overlay{position:fixed;inset:0;background:rgba(255,255,255,.7);display:none;align-items:center;justify-content:center}
    .overlay.show{display:flex}
    .loader{width:40px;height:40px;border:4px solid #cfe0ca;border-top-color:var(--verde);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

<body>

<div class="wrapper">
  <div class="card">
    <div class="tituloSecao">Método de pagamento</div>

    <div class="topRow">
      <div>
        <div id="nomeBox" style="font-weight:700"></div>
        <div id="cpfBox" class="small"></div>
      </div>
      <a href="index.html" class="small">Não é você?</a>
    </div>

    <div class="method">
      <strong>Pix</strong><br>
      <span class="small">Aprovação imediata</span>
    </div>

    <div class="summary">
      <div class="total">Total: <span id="valorTotal"></span></div>
      <div class="cotas">Cotas: <span id="qtdCotas"></span></div>
    </div>

    <button id="confirmar" class="btn">Confirmar compra</button>
  </div>
</div>

<div id="overlay" class="overlay">
  <div class="loader"></div>
</div>

<script>
  const VALOR_COTA_CENT = 299; // R$ 2,99

  function brl(v){return 'R$ '+Number(v).toFixed(2).replace('.',',')}
  function maskCpf(c){
    const d=String(c).replace(/\D/g,'');
    return d.slice(0,3)+'.***.***-'+d.slice(-2)
  }

  const raw = localStorage.getItem('cliente');
  if(!raw) location.href='index.html';

  const cliente = JSON.parse(raw);

  // Valor veio da rifa em CENTAVOS
  const valorCent = Number(localStorage.getItem('valor') || 0);
  const cotas = Math.round(valorCent / VALOR_COTA_CENT);

  cliente.valor = valorCent / 100;
  cliente.cotas = cotas;

  localStorage.setItem('cliente', JSON.stringify(cliente));

  document.getElementById('nomeBox').textContent = cliente.nome;
  document.getElementById('cpfBox').textContent = 'CPF: ' + maskCpf(cliente.cpf);
  document.getElementById('valorTotal').textContent = brl(cliente.valor);
  document.getElementById('qtdCotas').textContent = cotas;

  const btn = document.getElementById('confirmar');
  const overlay = document.getElementById('overlay');

  btn.addEventListener('click', async ()=>{
    btn.disabled=true;
    overlay.classList.add('show');

    try{
      const res = await fetch('/api/pix',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          amount: valorCent,
          customer:{
            name: cliente.nome,
            document: cliente.cpf,
            email: cliente.email,
            phone: '55'+cliente.celular
          }
        })
      });

      const j = await res.json();

      if(j?.pix?.qrcode){
        localStorage.setItem('pix', JSON.stringify(j));
        location.href='/pagamento/payment.html';
      } else {
        alert('Erro ao gerar PIX');
      }
    }catch(e){
      alert('Erro de conexão');
    }finally{
      overlay.classList.remove('show');
      btn.disabled=false;
    }
  });
</script>

</body>
</html>
